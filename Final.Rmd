---
title: "Analiza uspješnosti marketinške kampanje"
author: "Andrija Petrusić, Matija Luka Kukić, Dominik Gračner, Ivan Džanija"
date: "2025-01-15"
output: pdf_document
---

```{r,setup, include=FALSE, echo=T, error=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library('dplyr')
```

```{r, echo = FALSE, warning=FALSE}
marketingData <- read.csv("data/data.csv")
# head(marketingData)
```

## Deskriptivna statistika

Generalni pregled podataka i vizualizacija.

```{r, echo=FALSE, warning=FALSE}
# summary(marketingData)
```

```{r, echo = FALSE, warning=FALSE}
deposit_count <- table(marketingData$term_deposit_accepted)
cat("Uplaćen depozit(uspješna kampanja) - Binarna varijabla\n")
cat(deposit_count)

previous_deposit_count <- table(marketingData$previous_campaign_outcome)
cat("\nUspješnost prethodne kampanje\n")
cat(previous_deposit_count)

marital_status_count <- table(marketingData$marital_status)
cat("\nBračni status\n")
cat(marital_status_count)

education_count <- table(marketingData$education)
cat("\nRazina edukacije\n")
cat(education_count)

housing_loan_count <- table(marketingData$housing_loan)
cat("\nIma li stambeni kredit?\n")
cat(housing_loan_count)

personal_loan_count <- table(marketingData$personal_loan)
cat("\nIma li osobni zajam?\n")
cat(personal_loan_count)
```

```{r, echo = FALSE, warning=FALSE}
barplot(table(marketingData$job), main = "Posao",
        col = "lightblue",
        ylab = "Frekvencija",
        las = 2,
        cex.names = 0.7)
```

## *Postoji li zavisnost između zanimanja i bračnog statusa klijenta?*

Prvo ćemo provjeriti imamo li nedostajućih vrijednosti i uzeti samo stupce koji su nam bitni za ovo testiranje. Također iz stupca "job" ćemo makuti vrijednosti "unknown" jer ne nose nikakvu informaciju za ovo testiranje.

```{r, echo = FALSE, warning=FALSE}
rel = marketingData[names(marketingData) %in% c('job','marital_status')]
rel = rel[rel$job != 'unknown', ]
status <- c('job', 'marital_status')
for (colName in status){
  if (sum(is.na(marketingData[,colName])) > 0){
    cat('Ukupno nedostajućih vrijednosti za varijablu ',colName, ': ', sum(is.na(marketingData[,colName])),'\n')
  }
  else {
    cat('Nema nedostajućih vrijednosti za ', colName, '\n')
  }
}

```

Za testiranje zavisnosti zanimanja i bračnog statusa razmatramo $\chi^2$ test nezavinosti.

Pretpostavke:

-   kategorički podatci - zadovoljeno

-   očekivane frekvencije svake ćelije tablice mora biti minimalno 5

### Provjera očekivanih vrijednosti

Izrađujemo kontigencijsku tablicu i provjeravamo kolika je očekivana vrijednost za svaku ćeliju.

```{r, echo = FALSE, warning=FALSE}
tab = addmargins(table(rel$job,rel$marital_status))
cat("\t\tKontigencijska tablica\n")
print(tab)
```

```{r, echo = FALSE, warning=FALSE}
cat("H0: Kategorijski podatci su nezavisni\n")
cat("H1: Kategorijski podatci nisu nezavisni\n")
cat("Alpha value = 0.05\n")
chi_squared_result <- chisq.test(tab)
expected_values <- chi_squared_result$expected
for (val in expected_values)
  if (val < 5){
    cat("Očekivana vrijednost manja od 5!")
  }
print(chi_squared_result)
```

### Zaključak

Prvo vidimo kako niti jedna očekivana vrijednost nije manja od 5 te zaključujemo da možemo provesti zamišljeni test.

Na temelju testa odbacujemo H0(Kategorijski podatci su nezavisni) u korist H1(Kategorijski podatci nisu nezavisni) te zaključemo da postoji statistički značajna zavisnost između zanimanja i bračnost statusa klijenta na razini značajnosti $\alpha$ = 5%.

## ***Imaju li klijenti s otvorenim kreditom više novca na računu od ostalih klijenata?***

Za provjeru zavisnosti financijskog stanja klijenta i trenutno otvorenog kredita razmatramo T-test za dva uzorka.

Pretpostavke:

-   Numerički podatci - zadovoljeno(razdvajamo na dvije skupine numeričkih podataka)

-   Normalna distribucija podataka

### Provjera normalnosti podataka

Uzimamo stupce koji su nam bitni - kredit i stanje računa te dodajmo stupac koji sadrži "yes" ako klijent ima neki od dva kredita, a inače "no".

```{r, echo = FALSE, warning=FALSE}
stripped = select(marketingData, c("balance", "housing_loan", "personal_loan"))
stripped$open_any_loan <- ifelse(stripped$housing_loan == "yes" | stripped$personal_loan == "yes", "yes", "no")
summary(stripped)
```

Provjerimo vrijednosti kategoričkih podataka i nalazimo li na nedostajuće vrijednosti.

```{r, echo = FALSE, warning=FALSE}
'Moguće vrijednosti za stambeni kredit: '
unique(stripped$housing_loan)
'Moguće vrijednosti za osobni zajam: '
unique(stripped$personal_loan)

for (col_name in names(stripped)){
  if (sum(is.na(stripped[,col_name])) > 0){
    cat('Ukupno nedostajućih vrijednosti za varijablu ',col_name, ': ', sum(is.na(fifa19[,col_name])),'\n')
  }
}
count = 0
for(vrijednost in stripped$balance){
  if(vrijednost < 0){
    count = count + 1
  }
}
cat('Broj negativnih stanja računa: ', count)
cat('\nDimenzije podataka: ',dim(stripped))
```

Vidimo kako nema nedostajućih vrijednosti.

Vizualiziramo podatke i provodimo moguće testove na normalnost podataka.

```{r, echo = FALSE, warning=FALSE}
hloan <- table(stripped$housing_loan)
cat("\nIma li stambeni kredit?")
print(hloan)

ploan <- table(stripped$personal_loan)
cat("\nIma li osobni zajam?")
print(ploan)

aloan <- table(stripped$open_any_loan)
cat("\nIma li osobni zajam?")
print(aloan)
hist(stripped$balance - min(stripped$balance)+1,main='Financijsko stanje', xlab='eur', ylab='Frequency')
balance_mean <- mean(stripped$balance)
balance_sd <- sd(stripped$balance)
h = hist(stripped$balance,
  main="Financijsko stanje - 3sigma pregled", 
  xlab="Balans",
  ylab="frekvencija",
  xlim = c(balance_mean - 3 * balance_sd, balance_mean + 3 * balance_sd),
  col="red"
)
hist(log(stripped$balance),main='Financijsko stanje bez negativnih vrijednosti - log(val)', xlab='eur', ylab='Frequency')
```

Primjećujemo postojanje velikih outliera, analiziramo njihovu frekvenciju te ih uklanjamo ukoliko nije značajna.

```{r, echo = FALSE, warning=FALSE}
stripped$z <- scale(stripped$balance)
summary(stripped$z)
cat('\nbroj vrijednosti sa z-vrijednošću većom od 3.29: ',sum(stripped$z > 3))
cat('\nbroj vrijednosti sa z-vrijednošću manjom od -3.29: ',sum(stripped$z < -3))
cat('\nukupan broj vrijednosti prvog seta: ', sum(stripped$balance))

final <- data.frame(stripped)
final <- subset(final, balance >= quantile(balance, 0.01) & balance <= quantile(balance, 0.99))
```

Vidimo kako su stršeće vrijednosti stvarno samo manjina podataka te ćemo i maknuti kako bi mogli lakše dalje vizualizirati i provoditi testove bez da pretjerano utječju stršeće vrijednosti. Izbacujemo samo 2% podataka.

```{r, echo = FALSE, warning=FALSE}
otvoren = final[final$open_any_loan == 'yes',]
neotvoren = final[final$open_any_loan == 'no',]

cat('Prosječno stanje računa klijenata s otvorenim kreditom: ', mean(otvoren$balance))
cat('\nProsječno stanje računa klijenata bez otvorenog kredita: ', mean(neotvoren$balance))

boxplot(otvoren$balance, neotvoren$balance, 
        names = c("Financijsko stanje klijenata\ns otvorenim kreditom", 
                  "Financijsko stanje klijenata\nbez otvorenog kredita"),
        main='Usporedba stanja računa')
 
```

Sada ćemo vizualizirati histogramom i qq-plotom izgled distribucija te ćemo također provesti Kolmogorov-Smirnov test. Za Kolmogorov-Smirnov moramo testirati specifičnu distribuciju što znači da moramo prosljediti i parametre distribucije prema kojoj hoćemo testirati.

```{r, echo = FALSE, warning=FALSE}
hist(otvoren$balance, 
     main='Histogram stanja računa klijenata s otvorenim kreditom',
     xlab='Stanje računa u eurima')
hist(neotvoren$balance, 
     main='Histogram stanja računa klijenata bez otvorenog kredita',
     xlab='Stanje računa u eurima')

qqnorm(otvoren$balance, pch = 1, frame = FALSE,main='Financijsko stanje klijenata s otvorenim kreditom')
qqline(otvoren$balance, col = "steelblue", lwd = 2)

qqnorm(neotvoren$balance, pch = 1, frame = FALSE,main='Financijsko stanje klijenata bez otvorenog kreditom')
qqline(neotvoren$balance, col = "steelblue", lwd = 2)

cat("Alpha value = 0.05\n")
ks.test(otvoren$balance, "pnorm", mean = mean(otvoren$balance), sd = sd(otvoren$balance))
ks.test(neotvoren$balance, "pnorm", mean = mean(neotvoren$balance), sd = sd(neotvoren$balance))
```

Zaključak: Odbacujemo H0(normalnost distribucije) u koristi H1(nemamo normalnost distribucije) za oba uzorka. Kao što smo mogli i pretpostaviti financijsko stanje klijenata nije normalno distribuirano. Znači ne možemo koristiti T-test za provjeru.

### Neparametski test

Pošto nemamo pretpostavku normalnosti ne možemo koristiti T-test te provodimo neparametarski test. Test koji provodimo je Mann-Whitney-Wilcoxonov test/Mann–Whitney U test/Wilcoxon rank-sum test

```{r, echo = FALSE, warning=FALSE}
cat("H0: Medijani su jednaki\n")
cat("H1: Medijani su različiti\n")
cat("Alpha value = 0.05\n")
wilcox.test(otvoren$balance, neotvoren$balance, paired = FALSE)
```

### Zaključak

Nismo mogli provesti T-test jer nismo imali zadovoljenu pretpostavku normalnosti te smo odlučili provesti neparametarski MWW/MWU test za 2 nezavisna uzorka. Na temelju testa odbacujemo H0(medijani su jednaki) u koristi H1(medijani su različiti) na razini značajnosti $\alpha$ = 5%.

## *Postoji li razlika trajanja poziva marketinške kampanje među klijentima različitog stupnja obrazovanja?*

Prvo uzimamo samo podatke koji su nam potrebni za provedbu ovog testa te provjeravamo postoje li nedostajuće vrijednosti. Također ćemo maknuti podatke za "education" s vrijednosti "unknown" jer nam ne nose informaciju u ovom testiranju.

```{r}
stripped = select(marketingData, c("last_contact_duration", "education"))

for (col_name in names(stripped)){
  if (sum(is.na(stripped[,col_name])) > 0){
    cat('Ukupno nedostajućih vrijednosti za varijablu ',col_name, ': ', sum(is.na(stripped[,col_name])),'\n')
  }
}
final <- subset(stripped, education != "unknown")
```

Razdvajamo podatke na 3 različite skupine: Primary, Secondary i Tertiary koje predstavljuju stupnjeve obrazovanja klijenata

```{r}
primary = final[final$education == 'primary',]
secondary = final[final$education == 'secondary',]
tertiary = final[final$education == 'tertiary',]

cat('Prosječno trajanje razgovora - primary: ', median(primary$last_contact_duration))
cat('\nProsječno trajanje razgovora - secondary: ', median(secondary$last_contact_duration))
cat('\nProsječno trajanje razgovora - tertiary: ', median(tertiary$last_contact_duration))

```

Za provođenje ovog istraživačko pitanja razmatramo ANOVA test.

Pretpostavke:

-   Normalna distribucija podataka unutar pojedine skupine

-   Homogenost varijance između skupina(homoskedastičnost)

-   Nezavisnost podataka - zadovoljeno

### Provjera normalnosti podataka

Distribuciju podataka unutar svake skupine prikazati ćemo histogramom i qq-plotom. Također testiramo normalnost Lilliforsovom inačicom Kolmogorov-Smirnovljeva testa.

```{r}
library(nortest)
hist(primary$last_contact_duration, 
     main='Histogram primary',
     xlab='Duljina poziva')
hist(secondary$last_contact_duration, 
     main='Histogram secondary',
     xlab='Duljina poziva')
hist(tertiary$last_contact_duration, 
     main='Histogram tertiary',
     xlab='Duljina poziva')


qqnorm(primary$last_contact_duration, pch = 1, frame = FALSE,main='primary')
qqline(primary$last_contact_duration, col = "steelblue", lwd = 2)

qqnorm(secondary$last_contact_duration, pch = 1, frame = FALSE,main='secondary')
qqline(secondary$last_contact_duration, col = "steelblue", lwd = 2)

qqnorm(tertiary$last_contact_duration, pch = 1, frame = FALSE,main='tertiary')
qqline(tertiary$last_contact_duration, col = "steelblue", lwd = 2)

cat("Alpha value = 0.05\n")
lillie.test(primary$last_contact_duration)
lillie.test(secondary$last_contact_duration)
lillie.test(tertiary$last_contact_duration)
```

Zaključak: Odbacujemo H0(normalnost distribucije) u koristi H1(nemamo normalnost distribucije) za sve uzorke. Znači ne možemo koristiti ANOVA test te onda nemamo ni potrebe dalje testirati homoskedastičnost uzoraka.

### Neparametski test

Pošto nemamo pretpostavku normalnosti ne možemo koristiti ANOVA test te provodimo neparametarski test. Test koji provodimo je Kruskal–Wallis test.
Jedini uvjet za primjenjivos Kruskal-Wallis testa je: veličina svakog uzorka barem 5 što je zadovoljeno.

```{r}
data <- marketingData
data <- data.frame(
  value = c(primary$last_contact_duration, secondary$last_contact_duration, tertiary$last_contact_duration),  
  group = rep(c("primary", "secondary", "tertiary"), times = c(length(primary$last_contact_duration), length(secondary$last_contact_duration), length(tertiary$last_contact_duration)))
)
cat("H0: Medijani su jednaki\n")
cat("H1: Medijani su različiti\n")
cat("Alpha value = 0.05\n")
kruskal_result <- kruskal.test(value ~ group, data = data)
print(kruskal_result)
```
### Zaključak 

Nismo mogli provesti ANOVA test jer nismo imali zadovoljenu pretpostavku normalnosti te smo odlučili provesti neparametarski Kruskal-Wallis test. Na temelju testa odbacujemo H0(medijani su jednaki) u koristi H1(medijani su različiti) na razini značajnosti $\alpha$ = 5%.
